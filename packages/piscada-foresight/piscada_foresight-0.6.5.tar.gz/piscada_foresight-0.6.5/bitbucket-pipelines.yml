definitions:
  steps:
    - step: &test
        name: Test
        image: ghcr.io/astral-sh/uv:0.4-python3.12-bookworm-slim
        script:
          - export UV_LINK_MODE=copy
          - export PYTHONUNBUFFERED=1
          - uv run pytest ./tests/
        artifacts:
          - test-reports/**
    - step: &lint
        name: Lint
        image: ghcr.io/astral-sh/uv:0.4-python3.12-bookworm-slim
        script:
          - export UV_LINK_MODE=copy
          - export PYTHONUNBUFFERED=1
          - uv run ruff check ./
          - uv run mypy ./src
          - uv run bandit --recursive ./src
    - step: &publish
        name: Publish to PyPI
        image: ghcr.io/astral-sh/uv:0.4-python3.12-bookworm-slim
        script:
          - export UV_LINK_MODE=copy
          - export PYTHONUNBUFFERED=1
          - uv build
          - uv publish --token "$PYPI_TOKEN"

pipelines:
  default:
    - parallel:
        - step: *test
        - step: *lint
  custom:
    publish:
      - parallel:
          - step: *test
          - step: *lint
      - step: *publish
