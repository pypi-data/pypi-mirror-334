'''
<div class="sv-panel sv-panel-primary">
  <div class="sv-panel-heading">
    <h2 class="sv-panel-title">Your personal information</h2>
  </div>
  <div class="sv-panel-body">                
    <div class="sv-form-container">                
      <div class="sv-form-horizontal">                                
        <fieldset>
          <legend>Your personal information</legend>
          <input type="hidden" name="#.TTE.MENSYS.1-1" value="BWI5ho/6wqdNGDdhtk6Neunsu6cio/tAGz526Sxb7/o=;mod;73423F00;CxJDU1RBRkZfSVBVAyJDMQ==">
          
          <div class="sv-form-group"> 
            <label class="sv-col-sm-3 sv-control-label" for="ANSWER.TTQ.MENSYS.1.">Given name</label>
            <div class="sv-col-sm-4">
              <input type="text" name="ANSWER.TTQ.MENSYS.1" id="ANSWER.TTQ.MENSYS.1." value="" data-ttqseqn="1" class="sv-form-control">
              <input type="hidden" name="DUM_FIXT.TTQ.MENSYS.1">
            </div>
            <span class="sv-col-sm-5 sv-help-block" id="ANSWER.TTQ.MENSYS.1.helpblock"> 
              <span class="sv-trans-block" id="ANSWER.TTQ.MENSYS.1.transblock"></span> 
              <span class="sv-error-block" id="ANSWER.TTQ.MENSYS.1.errorblock"></span> 
            </span>
          </div>                           
          
          <div class="sv-form-group"> 
            <label class="sv-col-sm-3 sv-control-label" for="ANSWER.TTQ.MENSYS.2.">Family name&nbsp;*</label>
            <div class="sv-col-sm-4">
              <input type="text" name="ANSWER.TTQ.MENSYS.2" id="ANSWER.TTQ.MENSYS.2." value="" data-webvalidation="on" data-ttqseqn="2" class="sv-form-control sv-mandatory">
              <input type="hidden" name="DUM_FIXT.TTQ.MENSYS.2">
            </div>
            <span class="sv-col-sm-5 sv-help-block" id="ANSWER.TTQ.MENSYS.2.helpblock"> 
              <span class="sv-trans-block" id="ANSWER.TTQ.MENSYS.2.transblock"></span> 
              <span class="sv-error-block" id="ANSWER.TTQ.MENSYS.2.errorblock"></span> 
            </span>
          </div>                           
          
          <div class="sv-form-group"> 
            <label class="sv-col-sm-3 sv-control-label" for="ANSWER.TTQ.MENSYS.3.">Date of birth (DD/MM/YYYY)&nbsp;*</label>
            <div class="sv-col-sm-4">
              <div class="sv-input-group">
                <input type="text" name="ANSWER.TTQ.MENSYS.3" id="ANSWER.TTQ.MENSYS.3." value="" data-webvalidation="on" data-ttqseqn="3" class="sv-form-control sv-mandatory hasDatepicker">
                <span class="sv-input-group-addon">
                  <img class="ui-datepicker-trigger" src="../images/si_calendar.gif" alt="Select a date" title="Select a date" role="button" tabindex="0">
                </span>
              </div>
              <script>
                sits_attach_event(window,"load",function() {
                  sits_date_picker("#ANSWER\\.TTQ\\.MENSYS\\.3\\.",true,"","",ttq_set_date);
                });
              </script>
              <input type="hidden" name="DUM_FIXT.TTQ.MENSYS.3">
            </div>
            <span class="sv-col-sm-5 sv-help-block" id="ANSWER.TTQ.MENSYS.3.helpblock"> 
              <span class="sv-trans-block" id="ANSWER.TTQ.MENSYS.3.transblock"></span> 
              <span class="sv-error-block" id="ANSWER.TTQ.MENSYS.3.errorblock"></span> 
            </span>
          </div>                           
          
          <div class="sv-form-group"> 
            <label class="sv-col-sm-3 sv-control-label" for="ANSWER.TTQ.MENSYS.4.">Email&nbsp;*</label>
            <div class="sv-col-sm-4">
              <input type="text" name="ANSWER.TTQ.MENSYS.4" id="ANSWER.TTQ.MENSYS.4." value="" data-webvalidation="on" data-ttqseqn="4" class="sv-form-control sv-mandatory">
              <input type="hidden" name="DUM_FIXT.TTQ.MENSYS.4">
            </div>
            <span class="sv-col-sm-5 sv-help-block" id="ANSWER.TTQ.MENSYS.4.helpblock"> 
              <span class="sv-trans-block" id="ANSWER.TTQ.MENSYS.4.transblock"></span> 
              <span class="sv-error-block" id="ANSWER.TTQ.MENSYS.4.errorblock"></span> 
            </span>
          </div>                           
          
          <div class="sv-form-group"> 
            <label class="sv-col-sm-3 sv-control-label" for="ANSWER.TTQ.MENSYS.5.">Confirm email address&nbsp;*</label>
            <div class="sv-col-sm-4">
              <input type="text" name="ANSWER.TTQ.MENSYS.5" id="ANSWER.TTQ.MENSYS.5." value="" data-webvalidation="on" data-ttqseqn="5" class="sv-form-control sv-mandatory">
              <input type="hidden" name="DUM_FIXT.TTQ.MENSYS.5">
            </div>
            <span class="sv-col-sm-5 sv-help-block" id="ANSWER.TTQ.MENSYS.5.helpblock"> 
              <span class="sv-trans-block" id="ANSWER.TTQ.MENSYS.5.transblock"></span> 
              <span class="sv-error-block" id="ANSWER.TTQ.MENSYS.5.errorblock"></span> 
            </span>
          </div>                           
          
          <div class="sv-form-group"> 
            <p class="sv-col-sm-3 sv-checkbox-text"></p>
            <div class="sv-col-sm-4">
              <div class="sv-checkbox">
                <label for="ANSWER.TTQ.MENSYS.6.">
                  <input type="checkbox" name="ANSWER.TTQ.MENSYS.6" id="ANSWER.TTQ.MENSYS.6." value="Y" data-webvalidation="on" data-ttqseqn="6">
                  <span>I have read and agree to the <a href="http://sydney.edu.au/apply-terms.shtml" target="_blank">terms and conditions</a>&nbsp;*</span>
                </label>
              </div>
              <input type="hidden" name="DUM_FIXT.TTQ.MENSYS.6">
            </div>
            <span class="sv-col-sm-5 sv-help-block" id="ANSWER.TTQ.MENSYS.6.helpblock"> 
              <span class="sv-trans-block" id="ANSWER.TTQ.MENSYS.6.transblock"></span> 
              <span class="sv-error-block" id="ANSWER.TTQ.MENSYS.6.errorblock"></span> 
            </span>
          </div>                           
          
          <div class="sv-form-group"> 
            <p class="sv-col-sm-3 sv-checkbox-text"></p>
            <div class="sv-col-sm-4">
              <div class="sv-checkbox">
                <label for="ANSWER.TTQ.MENSYS.7.">
                  <input type="checkbox" name="ANSWER.TTQ.MENSYS.7" id="ANSWER.TTQ.MENSYS.7." value="Y" data-webvalidation="on" data-ttqseqn="7">
                  <span>I have read and acknowledged the <a href="http://sydney.edu.au/apply-privacy.shtml" target="_blank">Privacy statement</a>&nbsp;*</span>
                </label>
              </div>
              <input type="hidden" name="DUM_FIXT.TTQ.MENSYS.7">
            </div>
            <span class="sv-col-sm-5 sv-help-block" id="ANSWER.TTQ.MENSYS.7.helpblock"> 
              <span class="sv-trans-block" id="ANSWER.TTQ.MENSYS.7.transblock"></span> 
              <span class="sv-error-block" id="ANSWER.TTQ.MENSYS.7.errorblock"></span> 
            </span>
          </div>                           
          
          <input type="hidden" name="#.TTQ.MENSYS.1" value="Bi2a3taMLVefmBmTQ0B9cMpVy/vhTWOuYiLFYikgIns=;mod;FB1A4E05;AzJDMQsSQ1NUQUZGX0lQVQMiQzE=">
          <input type="hidden" name="#.TTQ.MENSYS.2" value="oi4yDghLyPzGjnp06XOfCv+WaNBtr5SCqq20IMh2TZY=;mod;8CAF93CA;AzJDMgsSQ1NUQUZGX0lQVQMiQzE=">
          <input type="hidden" name="#.TTQ.MENSYS.3" value="29GJuyxsZxyp5NZVGtwcv0Q41eGBZkbORgTvsDZOE5k=;mod;14862092;AzJDMwsSQ1NUQUZGX0lQVQMiQzE=">
          <input type="hidden" name="#.TTQ.MENSYS.4" value="TLTTWNS+Uonhv9KSbVgx4GJAitqN70UngCSVAwwcVpY=;mod;CAA94755;AzJDNAsSQ1NUQUZGX0lQVQMiQzE=">
          <input type="hidden" name="#.TTQ.MENSYS.5" value="6P24zSRtW27nqkVLiuXoHvlHu4sdZPbIJYvypoOIlIs=;mod;3088A5CB;AzJDNQsSQ1NUQUZGX0lQVQMiQzE=">
          <input type="hidden" name="#.TTQ.MENSYS.6" value="VjvHppEatihCHRN95+Ii56OpBjM6swnEYdRPW0BVFO4=;mod;87B66E2D;AzJDNgsSQ1NUQUZGX0lQVQMiQzE=">
          <input type="hidden" name="#.TTQ.MENSYS.7" value="/fSthHMh9TQ5bIgYV1Cq4Ux++/4OSWkzoh07NFCXDIU=;mod;6836E816;AzJDNwsSQ1NUQUZGX0lQVQMiQzE=">           
        </fieldset>  
      </div>
    </div>
  </div>  
  <div class="sv-panel-footer">
    <div class="sv-btn-container sv-btn-container-inline">
      <!-- back and quit fields need to be rawHtml to add formnovalidate attribute -->                    
      <!-- <x-subst class="sv-col-xs-12 sv-col-sm-2 sv-btn sv-btn-default" type="submit" name="BACK.DUMMY.MENSYS"  title="Back"></x-subst>	 -->
      <!-- <x-subst class="sv-col-xs-12 sv-col-sm-2 sv-btn sv-btn-default" type="submit" name="QUIT_BUT.DUMMY.MENSYS" title="Quit"></x-subst>	 	 -->
      <input type="submit" title="Exit" value="Exit" name="QUIT_BUT.DUMMY.MENSYS.1" class="sv-col-xs-12 sv-col-sm-2 sv-btn sv-btn-default">	  	  
      <input type="submit" name="NEXT.DUMMY.MENSYS.1" value="Create" class="sv-col-xs-12 sv-col-sm-2 sv-btn sv-btn-primary" title="Next" disabled="">	                        
    </div>
  </div>
</div>
'''

import re
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from forms.utils.form_utils import set_value_by_id, select_option_by_id, check_button_by_id, select_radio_by_value

class CreateProfileForm:
    def __init__(self, driver, data):
        self.driver = driver
        self.data = data

    def run(self):
        students = self.data
        driver = self.driver
        personal_info = students[-1][0]
        
        # Fill in Given Name
        given_name = personal_info.get('Given Name', '')
        if not given_name:
            given_name = "DefaultFirstName"
        set_value_by_id(driver, "givenName", given_name)
        
        # Fill in Family Name
        family_name = personal_info.get('Family Name', '')
        if not family_name:
            family_name = "DefaultLastName"
        set_value_by_id(driver, "familyName", family_name)
        
        # Select gender
        gender = personal_info.get('Gender', 'Male')
        gender_mapping = {
            'male': 'M',
            'female': 'F',
            'other': 'X'
        }
        gender_code = gender_mapping.get(gender.lower(), 'M')
        select_radio_by_value(driver, "gender", gender_code)
        
        # Fill in Date of Birth
        dob = personal_info.get('DOB', '')
        if not dob:
            # Try alternative keys for DOB
            dob_keys = ['Date of Birth', 'DOB (dd/mm/yyyy)', 'Birth Date']
            for key in dob_keys:
                if key in personal_info:
                    dob = personal_info[key]
                    break
                    
        if not dob:
            dob = "01/01/2000"  # Default DOB if not found
        
        set_value_by_id(driver, "dateOfBirth", dob)
        
        # Fill in Email
        email = personal_info.get('Email', '')
        if not email:
            email = personal_info.get('email', '')  # Try alternate key
            
        if not email:
            email = f"{given_name.lower()}.{family_name.lower()}@example.com"  # Default email
            
        set_value_by_id(driver, "email", email)
        
        # Confirm Email
        set_value_by_id(driver, "confirmEmail", email)
        
        # Select Country
        country = personal_info.get('Country', 'China (Excludes SARS and Taiwan)')
        select_option_by_id(driver, "nationality", country)
        
        # Accept terms checkbox
        check_button_by_id(driver, "agreeTerms")
        
        # Optionally submit the form
        # check_button_by_id(driver, "submitButton")
        
        # Wait for form submission/processing
        # WebDriverWait(driver, 10).until(...) 
    
    # No longer need these methods as they're imported from form_utils.py