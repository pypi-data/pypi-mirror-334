"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[851],{40851:(e,s,t)=>{t.d(s,{A:()=>E});var a=t(74848),l=t(81924),r=t(61626),n=t(78714),i=t(96540),o=t(77528),c=t(71468),d=t(29838),u=t(73232);let m=e=>{let{workflowID:s,sessionId:t}=e,a=(0,c.wA)(),r=(0,c.d4)(e=>e.flow.nodes),[n,m]=(0,i.useState)(!1),[x,f]=(0,i.useState)(null),h=(0,i.useRef)([]),[p,g]=(0,i.useState)(()=>t||"chat_session_".concat(Date.now(),"_").concat(Math.random().toString(36).substring(2,9)));(0,i.useEffect)(()=>{t&&g(t)},[t]),(0,i.useEffect)(()=>()=>{h.current.forEach(e=>clearInterval(e)),h.current=[]},[]);let w=(0,i.useCallback)(e=>{0!==e.length&&e.forEach(e=>{let s=e.node_id,t=r.find(e=>e.id===s||e.data.title===s);if(!t){let e=u.A.getState(),a=Object.keys(e.flow.nodeConfigs).find(t=>e.flow.nodeConfigs[t].title===s);a&&(t=r.find(e=>e.id===a))}if(!t)return;let l=e.outputs||{},n=e.status;e.subworkflow_output&&Object.entries(e.subworkflow_output).forEach(e=>{let[s,t]=e,l=r.find(e=>e.id===s||e.data.title===s);l&&a((0,d.Kp)({id:l.id,data:{run:t,taskStatus:"COMPLETED"}}))}),t&&a((0,d.Kp)({id:t.id,data:{run:(0,o._)({},l),error:e.error||null,taskStatus:n}}))})},[r,a]);return{isLoading:n,error:x,executeWorkflow:(0,i.useCallback)(async e=>{if(!s)return f("No workflow connected"),null;try{m(!0),f(null),h.current.forEach(e=>clearInterval(e)),a((0,d.bT)());let t=(await (0,l.AD)(s,{input_node:{user_message:e,session_id:p,message_history:[]}},null,"interactive")).id;return new Promise(e=>{let s=setInterval(async()=>{try{let a=await (0,l.Wb)(t),r=a.tasks;if(w(r),"COMPLETED"===a.status||"FAILED"===a.status){clearInterval(s);let l=h.current.indexOf(s);l>-1&&h.current.splice(l,1);let n=a.workflow_version.definition.nodes.find(e=>"OutputNode"===e.node_type);if(!n){m(!1),f("No output node found in workflow"),e({role:"assistant",message:"Error: No output node found in workflow"});return}let i=r.find(e=>"COMPLETED"===e.status&&e.node_id===n.id&&e.outputs);if(i&&i.outputs){let s=i.outputs.assistant_message||JSON.stringify(i.outputs);m(!1),e({role:"assistant",message:"string"==typeof s?s:JSON.stringify(s),runId:t})}else if("FAILED"===a.status){let s=r.find(e=>"FAILED"===e.status),a=(null==s?void 0:s.error)||"Workflow execution failed";m(!1),f(a),e({role:"assistant",message:"Error: ".concat(a),runId:t})}else m(!1),f("Workflow completed but no response was generated"),e({role:"assistant",message:"Sorry, I couldn't generate a response.",runId:t})}}catch(a){console.error("Error checking workflow status:",a),clearInterval(s);let t=h.current.indexOf(s);t>-1&&h.current.splice(t,1),m(!1),f("Error checking workflow status"),e({role:"assistant",message:"Sorry, an error occurred while processing your message."})}},1e3);h.current.push(s)})}catch(e){return console.error("Error executing chat workflow:",e),m(!1),f((null==e?void 0:e.message)||"Failed to execute workflow"),{role:"assistant",message:"Sorry, an error occurred while processing your message."}}},[s,p,a,w]),cleanup:(0,i.useCallback)(()=>{h.current.forEach(e=>clearInterval(e)),h.current=[]},[]),sessionId:p}};var x=t(55456),f=t(4418),h=t(67795),p=t(83440),g=t(47694),w=t(23907),v=t(72748),j=t(98536),y=t(31024),N=t(80429),b=t(37399);let I=i.forwardRef((e,s)=>{var{avatar:t,message:l,showFeedback:r,attempts:n=1,currentAttempt:c=1,status:d,runId:u,onMessageCopy:m,onAttemptChange:I,onFeedback:k,onAttemptFeedback:C,className:S,messageClassName:E}=e,_=(0,f._)(e,["avatar","message","showFeedback","attempts","currentAttempt","status","runId","onMessageCopy","onAttemptChange","onFeedback","onAttemptFeedback","className","messageClassName"]);let[D,P]=i.useState(),[T,A]=i.useState(),M=i.useRef(null),{copied:O,copy:R}=(0,N.i)(),z=(0,a.jsxs)("p",{children:["Something went wrong, if the issue persists please contact us through our help center at\xa0",(0,a.jsx)(h.h,{href:"mailto:support@acmeai.com",size:"sm",children:"support@acmeai.com"})]}),L=(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(b.In,{className:"text-default-500 animate-spin",icon:"gravity-ui:spinner"}),(0,a.jsx)("p",{children:"Generating response..."})]}),W="failed"===d,H="loading"===d,F=i.useCallback(()=>{var e;let s="";"string"==typeof l?s=l:Array.isArray(l)&&l.forEach(e=>{var t,a;let l="string"==typeof e?e:null==e?void 0:null===(a=e.props)||void 0===a?void 0:null===(t=a.children)||void 0===t?void 0:t.toString();l&&(s+=l+"\n")});let t=s||(null===(e=M.current)||void 0===e?void 0:e.textContent)||"";R(t),null==m||m(t)},[R,l,m]),G=i.useCallback(e=>{P(e?"like":"dislike"),null==k||k(e?"like":"dislike")},[k]),J=i.useCallback(e=>{A(e),null==C||C(e)},[C]);return(0,a.jsxs)("div",(0,x._)((0,o._)({},_),{ref:s,className:(0,p.cn)("flex gap-3",S),children:[(0,a.jsx)("div",{className:"relative flex-none",children:(0,a.jsx)(g.w,{isOneChar:!0,color:"danger",content:(0,a.jsx)(b.In,{className:"text-background",icon:"gravity-ui:circle-exclamation-fill"}),isInvisible:!W,placement:"bottom-right",shape:"circle",children:(0,a.jsx)(w.Q,{src:t})})}),(0,a.jsxs)("div",{className:"flex w-full flex-col gap-4",children:[(0,a.jsxs)("div",{className:(0,p.cn)("relative w-full rounded-medium bg-content2 px-4 py-3 text-default-600","failed"===d?"bg-danger-100/50 border border-danger-100 text-foreground":"","loading"===d?"bg-default-100/50 border border-default-100 text-foreground":"",E),children:[(0,a.jsx)("div",{ref:M,className:"pr-20 text-small",children:W?z:H?L:l}),r&&!W&&!H&&(0,a.jsxs)("div",{className:"absolute right-2 top-2 flex rounded-full bg-content2 shadow-small",children:[(0,a.jsx)(v.T,{isIconOnly:!0,radius:"full",size:"sm",variant:"light",onPress:F,children:O?(0,a.jsx)(b.In,{className:"text-lg text-default-600",icon:"gravity-ui:check"}):(0,a.jsx)(b.In,{className:"text-lg text-default-600",icon:"gravity-ui:copy"})}),(0,a.jsx)(v.T,{isIconOnly:!0,radius:"full",size:"sm",variant:"light",onPress:()=>G(!0),children:"like"===D?(0,a.jsx)(b.In,{className:"text-lg text-default-600",icon:"gravity-ui:thumbs-up-fill"}):(0,a.jsx)(b.In,{className:"text-lg text-default-600",icon:"gravity-ui:thumbs-up"})}),(0,a.jsx)(v.T,{isIconOnly:!0,radius:"full",size:"sm",variant:"light",onPress:()=>G(!1),children:"dislike"===D?(0,a.jsx)(b.In,{className:"text-lg text-default-600",icon:"gravity-ui:thumbs-down-fill"}):(0,a.jsx)(b.In,{className:"text-lg text-default-600",icon:"gravity-ui:thumbs-down"})})]}),n>1&&!W&&!H&&(0,a.jsxs)("div",{className:"flex w-full items-center justify-end",children:[(0,a.jsx)("button",{onClick:()=>null==I?void 0:I(c>1?c-1:1),children:(0,a.jsx)(b.In,{className:"cursor-pointer text-default-400 hover:text-default-500",icon:"gravity-ui:circle-arrow-left"})}),(0,a.jsx)("button",{onClick:()=>null==I?void 0:I(c<n?c+1:n),children:(0,a.jsx)(b.In,{className:"cursor-pointer text-default-400 hover:text-default-500",icon:"gravity-ui:circle-arrow-right"})}),(0,a.jsxs)("p",{className:"px-1 text-tiny font-medium text-default-500",children:[c,"/",n]})]}),u&&(0,a.jsx)("div",{className:"flex w-full items-center justify-end mt-2",children:(0,a.jsx)(j.R,{size:"sm",variant:"flat",className:"cursor-pointer",onClick:()=>window.open("/trace/".concat(u),"_blank"),children:u})})]}),r&&n>1&&!W&&!H&&(0,a.jsxs)("div",{className:"flex items-center justify-between rounded-medium border-small border-default-100 px-4 py-3 shadow-small",children:[(0,a.jsx)("p",{className:"text-small text-default-600",children:"Was this response better or worse?"}),(0,a.jsxs)("div",{className:"flex gap-1",children:[(0,a.jsx)(y.I,{content:"Better",children:(0,a.jsx)(v.T,{isIconOnly:!0,radius:"full",size:"sm",variant:"light",onPress:()=>J("like"),children:"like"===T?(0,a.jsx)(b.In,{className:"text-lg text-primary",icon:"gravity-ui:thumbs-up-fill"}):(0,a.jsx)(b.In,{className:"text-lg text-default-600",icon:"gravity-ui:thumbs-up"})})}),(0,a.jsx)(y.I,{content:"Worse",children:(0,a.jsx)(v.T,{isIconOnly:!0,radius:"full",size:"sm",variant:"light",onPress:()=>J("dislike"),children:"dislike"===T?(0,a.jsx)(b.In,{className:"text-lg text-default-600",icon:"gravity-ui:thumbs-down-fill"}):(0,a.jsx)(b.In,{className:"text-lg text-default-600",icon:"gravity-ui:thumbs-down"})})}),(0,a.jsx)(y.I,{content:"Same",children:(0,a.jsx)(v.T,{isIconOnly:!0,radius:"full",size:"sm",variant:"light",onPress:()=>J("same"),children:"same"===T?(0,a.jsx)(b.In,{className:"text-lg text-danger",icon:"gravity-ui:face-sad"}):(0,a.jsx)(b.In,{className:"text-lg text-default-600",icon:"gravity-ui:face-sad"})})})]})]})]})]}))});I.displayName="MessageCard";var k=t(83840);let C=i.forwardRef((e,s)=>{var{classNames:t={}}=e,l=(0,f._)(e,["classNames"]);return(0,a.jsx)(k.P,(0,o._)({ref:s,"aria-label":"Prompt",className:"min-h-[40px]",classNames:(0,x._)((0,o._)({},t),{label:(0,p.cn)("hidden",null==t?void 0:t.label),input:(0,p.cn)("py-0",null==t?void 0:t.input)}),minRows:1,placeholder:"Enter a prompt here",radius:"lg",variant:"bordered"},l))});function S(e){let{onSendMessage:s,isLoading:t=!1,placeholder:l="Enter a prompt here",disabled:r=!1,showRegenerateButton:n=!0}=e,[o,c]=i.useState(!1),[d,u]=i.useState(""),m=i.useRef(null),x=()=>{d.trim()&&s&&(s(d),u(""))};return(0,a.jsxs)("div",{className:"flex w-full flex-col gap-1",children:[n&&(0,a.jsx)("div",{children:(0,a.jsx)(v.T,{isDisabled:o||t||r,size:"sm",className:"h-7 min-w-0 px-2",startContent:(0,a.jsx)(b.In,{className:(0,p.cn)("text-medium",o?"origin-center animate-spin":""),icon:"solar:restart-linear",width:14}),variant:"flat",onPress:()=>{c(!0),setTimeout(()=>{c(!1)},1e3)},children:(0,a.jsx)("span",{className:"text-xs",children:"Regenerate"})})}),(0,a.jsxs)("form",{className:"flex w-full flex-col items-start rounded-medium bg-default-100 transition-colors hover:bg-default-200/70",onSubmit:e=>{e.preventDefault(),x()},children:[(0,a.jsx)(C,{ref:m,classNames:{inputWrapper:"!bg-transparent shadow-none",innerWrapper:"relative",input:"pt-1 pl-2 pb-4 !pr-10 text-medium max-h-20"},endContent:(0,a.jsx)("div",{className:"flex items-end gap-2",children:(0,a.jsx)(y.I,{showArrow:!0,content:"Send message",children:(0,a.jsx)(v.T,{isIconOnly:!0,color:d?"primary":"default",isDisabled:!d||t||r,radius:"lg",size:"sm",variant:"solid",onPress:x,type:"submit",children:(0,a.jsx)(b.In,{className:(0,p.cn)("[&>path]:stroke-[2px]",d?"text-primary-foreground":"text-default-600"),icon:"solar:arrow-up-linear",width:20})})})}),minRows:1,maxRows:3,radius:"lg",value:d,variant:"flat",onValueChange:u,isDisabled:t||r,placeholder:l,onKeyDown:e=>{"Enter"===e.key&&!e.shiftKey&&(e.preventDefault(),!d.trim()||t||r||x())}}),(0,a.jsxs)("div",{className:"flex w-full flex-wrap items-center justify-between gap-2 px-2 pb-2",children:[(0,a.jsx)("div",{className:"flex flex-wrap gap-2",children:(0,a.jsx)(v.T,{size:"sm",className:"h-6 min-w-0 px-2",startContent:(0,a.jsx)(b.In,{className:"text-default-500",icon:"solar:paperclip-linear",width:14}),variant:"flat",isDisabled:t||r,children:(0,a.jsx)("span",{className:"text-xs",children:"Attach"})})}),(0,a.jsxs)("div",{className:"flex items-center justify-end gap-2",children:[(0,a.jsxs)("p",{className:"py-1 text-tiny text-default-400",children:[d.length,"/2000"]}),(0,a.jsx)("span",{className:"text-xs text-default-400",children:"⏎ to send, ⇧+⏎ for new line"})]})]})]})]})}C.displayName="PromptInput";let E=i.memo(function(e){let{workflowID:s,onSendMessage:t,sessionId:o}=e,[c,d]=(0,i.useState)([]),u=(0,i.useRef)(null),{theme:x}=(0,n.D)(),[f,h]=(0,i.useState)(o||null),p=async()=>{if(s&&!o)try{let e=await (0,l.Zh)(s);h(e.id)}catch(e){console.error("Error creating test session:",e)}},g=async()=>{if(o)try{let e=(await (0,l.Ht)(o)).messages.map(e=>({role:e.content.role,message:e.content.content,runId:e.run_id}));d(e)}catch(e){console.error("Error fetching session messages:",e)}};(0,i.useEffect)(()=>{o?g():p()},[s,o]),(0,i.useEffect)(()=>{if(s&&!o){let e=sessionStorage.getItem("chat_messages_".concat(f||"default"));if(e)try{d(JSON.parse(e))}catch(e){console.error("Error parsing stored messages:",e)}}},[f,o]),(0,i.useEffect)(()=>{s&&!o&&c.length>0&&sessionStorage.setItem("chat_messages_".concat(f),JSON.stringify(c))},[c,s,o]);let{isLoading:w,error:v,executeWorkflow:j,cleanup:y}=m({workflowID:s,sessionId:f}),N=()=>"/pyspur-black.png",b=(0,i.useCallback)(async e=>{if(!e.trim())return;let a={role:"user",message:e};d(e=>[...e,a]);try{if(t&&await t(e),s){let s=await j(e);s&&d(e=>[...e,s])}else setTimeout(()=>{let s={role:"assistant",message:'This is a simulated response (no workflow connected): "'.concat(e,'"')};d(e=>[...e,s])},1e3)}catch(e){console.error("Error sending message:",e),d(e=>[...e,{role:"assistant",message:"Sorry, an error occurred while processing your message."}])}},[t,s,j]),k=(0,i.useCallback)(async()=>{s&&sessionStorage.removeItem("chat_messages_".concat(f||"default")),d([]),await p()},[s]);(0,i.useEffect)(()=>{u.current&&(u.current.scrollTop=u.current.scrollHeight)},[c,w]),(0,i.useEffect)(()=>()=>{y()},[y]);let C=(0,i.useCallback)(()=>0===c.length?(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center min-h-[300px] h-full p-4 text-center",children:[(0,a.jsxs)("div",{className:"mb-4",children:[(0,a.jsx)("img",{src:"/pyspur_white.png",alt:"PySpur Chat",className:"w-16 h-16 dark:block hidden"}),(0,a.jsx)("img",{src:"/pyspur-black.png",alt:"PySpur Chat",className:"w-16 h-16 dark:hidden block"})]}),(0,a.jsx)("h3",{className:"text-lg font-semibold mb-2",children:"Welcome to Spur Chat"}),(0,a.jsx)("p",{className:"text-default-500 mb-4 max-w-md",children:s?"This chat is powered by your workflow. Send a message to get started!":"No workflow is connected yet. Please connect a workflow to use this chat interface."}),!s&&(0,a.jsx)("p",{className:"text-xs text-default-400 mb-2",children:"Tip: Build a workflow that takes a message input and produces a response output."})]}):(0,a.jsxs)("div",{className:"flex flex-col gap-2 px-1",children:[c.map((e,s)=>(0,a.jsx)(I,{avatar:"assistant"===e.role?N():"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSIxMiIgY3k9IjYiIHI9IjQiIGZpbGw9ImN1cnJlbnRDb2xvciIvPjxwYXRoIGZpbGw9ImN1cnJlbnRDb2xvciIgZD0iTTIwIDE3LjVjMCAyLjQ4NSAwIDQuNS04IDQuNXMtOC0yLjAxNS04LTQuNVM3LjU4MiAxMyAxMiAxM3M4IDIuMDE1IDggNC41Ii8+PC9zdmc+",message:e.message,messageClassName:"user"===e.role?"bg-content3 text-content3-foreground":"",className:"py-0",runId:"assistant"===e.role?e.runId:void 0},s)),w&&(0,a.jsx)(I,{avatar:N(),message:"Thinking...",status:"loading",className:"py-0"}),v&&(0,a.jsx)(I,{avatar:N(),message:"Error: ".concat(v),messageClassName:"bg-danger-100 text-danger-700",className:"py-0"})]}),[c,w,v,s,x]),E=(0,i.useCallback)(()=>(0,a.jsx)(S,{onSendMessage:b,isLoading:w,placeholder:s?"Send a message...":"No workflow connected",disabled:!s,showRegenerateButton:!1}),[b,w,s]);return(0,a.jsxs)("div",{className:"flex h-full w-full max-w-full flex-col",children:[(0,a.jsxs)("div",{className:"flex w-full flex-wrap items-center justify-between gap-2 border-b-small border-divider py-1 px-4 flex-shrink-0",children:[(0,a.jsx)("p",{className:"text-sm font-medium",children:"Chat with your Spur"}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[c.length>0&&(0,a.jsx)("button",{onClick:k,className:"text-xs text-default-500 hover:text-default-700","aria-label":"Clear chat history",children:"Clear chat"}),(0,a.jsx)("p",{className:"text-xs text-default-400",children:f?"Session ID: ".concat(f):"No active session"})]})]}),(0,a.jsx)(r.H,{className:"flex flex-col p-2 overflow-y-auto flex-grow",ref:u,children:(0,a.jsx)(C,{})}),(0,a.jsx)("div",{className:"p-2 border-t border-divider flex-shrink-0",children:(0,a.jsx)(E,{})})]})})}}]);