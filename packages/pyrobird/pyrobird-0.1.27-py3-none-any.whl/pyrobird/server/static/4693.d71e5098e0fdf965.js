"use strict";(self.webpackChunkfirebird=self.webpackChunkfirebird||[]).push([[4693],{4693:(I,Y,k)=>{k.r(Y),k.d(Y,{TGraphPainter:()=>C,clTGraphAsymmErrors:()=>O});var A=k(467),p=k(6998),X=k(5680),E=k(9041),S=k(675),N=k(3277),z=k(2953),F=k(6823),H=k(6714),R=k(6370);const P=(0,p.BIT)(18),B="TGraphErrors",O="TGraphAsymmErrors",D="TGraphBentErrors",L="TGraphMultiErrors";class C extends S.JW{constructor(t,i){super(t,i),this.axes_draw=!1,this.bins=null,this.xmin=this.ymin=this.xmax=this.ymax=0,this.wheel_zoomy=!0,this.is_bent=i._typename===D,this.has_errors=i._typename===B||i._typename===L||i._typename===O||this.is_bent||i._typename.match(/^RooHist/)}getGraph(){return this.getObject()}getHistogram(){return this.getObject()?.fHistogram}setHistogram(t){const i=this.getObject();i&&(i.fHistogram=t)}redraw(){var t=this;return(0,A.A)(function*(){let i=Promise.resolve(!0);if(t.$redraw_hist){delete t.$redraw_hist;const e=t.getMainPainter();e?.isSecondary(t)&&t.axes_draw&&(i=e.redraw())}return i.then(()=>t.drawGraph()).then(()=>{const e=t._funcHandler?.drawNext(0)??t;return delete t._funcHandler,e})})()}cleanup(){delete this.interactive_bin,delete this.bins,super.cleanup()}get_gme(){const t=this.getGraph();return t?._typename===L?t:null}decodeOptions(t,i){(0,p.isStr)(t)&&0===t.indexOf("same ")&&(t=t.slice(5));const e=this.getGraph(),a=!!this.get_gme(),n=i?!!this.getMainPainter():!this.axes_draw;let h=[];this.options||(this.options={});const c=(l,f)=>{Object.assign(f,{Line:0,Curve:0,Rect:0,Mark:0,Bar:0,OutRange:0,EF:0,Fill:0,MainError:1,Ends:1,ScaleErrX:1}),a&&l.check("S=",!0)&&(f.ScaleErrX=l.partAsFloat()),l.check("L")&&(f.Line=1),l.check("F")&&(f.Fill=1),l.check("CC")&&(f.Curve=2),l.check("C")&&(f.Curve=1),l.check("*")&&(f.Mark=103),l.check("P0")&&(f.Mark=104),l.check("P")&&(f.Mark=1),l.check("B")&&(f.Bar=1,f.Errors=0),l.check("Z")&&(f.Errors=1,f.Ends=0),l.check("||")&&(f.Errors=1,f.MainError=0,f.Ends=1),l.check("[]")&&(f.Errors=1,f.MainError=0,f.Ends=2),l.check("|>")&&(f.Errors=1,f.Ends=3),l.check(">")&&(f.Errors=1,f.Ends=4),l.check("0")&&(f.Mark=1,f.Errors=1,f.OutRange=1),l.check("1")&&1===f.Bar&&(f.Bar=2),l.check("2")&&(f.Rect=1,f.Errors=0),l.check("3")&&(f.EF=1,f.Errors=0),l.check("4")&&(f.EF=2,f.Errors=0),l.check("5")&&(f.Rect=2,f.Errors=0),l.check("X")&&(f.Errors=0)};Object.assign(this.options,{Axis:"",NoOpt:0,PadStats:!1,PadPalette:!1,original:t,second_x:!1,second_y:!1,individual_styles:!1}),a&&t&&(t.indexOf(";")>0?(h=t.split(";"),t=h.shift()):t.indexOf("_")>0&&(h=t.split("_"),t=h.shift()));const r=this.options;let x=new E.nC(t),u="";if(z.c.forEach(l=>{x.check(l)&&(u+=";"+l)}),x.check("XAXIS_",!0)&&(u+=";XAXIS_"+x.part),x.check("YAXIS_",!0)&&(u+=";YAXIS_"+x.part),x.empty()&&(r.original=n?"lp":"alp",x=new E.nC(r.original)),x.check("NOOPT")&&(r.NoOpt=1),x.check("POS3D_",!0)&&(r.pos3d=x.partAsInt()-.5),x.check("PFC")&&!r._pfc&&(r._pfc=2),x.check("PLC")&&!r._plc&&(r._plc=2),x.check("PMC")&&!r._pmc&&(r._pmc=2),x.check("A")&&(r.Axis=x.check("I")?"A;":" "),x.check("X+")&&(r.Axis+="X+",r.second_x=n),x.check("Y+")&&(r.Axis+="Y+",r.second_y=n),x.check("RX")&&(r.Axis+="RX"),x.check("RY")&&(r.Axis+="RY"),a&&(r.blocks=[],r.skip_errors_x0=r.skip_errors_y0=!1,x.check("X0")&&(r.skip_errors_x0=!0),x.check("Y0")&&(r.skip_errors_y0=!0)),c(x,r),a&&x.check("S")&&(r.individual_styles=!0),void 0===r.Errors&&(r.Errors=!this.has_errors||a&&h.length?0:1),1===r.Mark&&1===e.fMarkerStyle&&(r.Mark=101),r.Line+r.Fill+r.Curve+r.Mark+r.Bar+r.EF+r.Rect+r.Errors===0&&x.empty()&&(r.Line=1),this.matchObjectType(B)){const l=e.fEX.length;let f=0;for(let y=0;y<l;++y)f=Math.max(f,e.fEX[y],e.fEY[y]);f<1e-100&&(r.Errors=0)}if(this._cutg=this.matchObjectType(p.clTCutG),this._cutg_lastsame=this._cutg&&e.fNpoints>3&&e.fX[0]===e.fX[e.fNpoints-1]&&e.fY[0]===e.fY[e.fNpoints-1],!r.Axis){const l=this.getPadPainter()?.getRootPad(!0);(!l||l?.fPrimitives?.arr[0]===this.getObject())&&(r.Axis=" ")}r.Axis+=u;for(let l=0;l<h.length;++l){const y={};c(new E.nC(h[l]),y),y.skip_errors_x0=r.skip_errors_x0,y.skip_errors_y0=r.skip_errors_y0,r.blocks.push(y)}}extractGmeErrors(t){if(!this.bins)return;const i=this.getGraph();this.bins.forEach(e=>{e.eylow=i.fEyL[t][e.indx],e.eyhigh=i.fEyH[t][e.indx]})}createBins(){const t=this.getGraph();if(!t)return;let i=0,e=t.fNpoints;this._cutg&&this._cutg_lastsame&&e--,t._typename===B?i=1:t._typename===L?i=2:(t._typename===O||t._typename===D||t._typename.match(/^RooHist/))&&(i=3),this.bins=new Array(e);for(let a=0;a<e;++a){const n=this.bins[a]={x:t.fX[a],y:t.fY[a],indx:a};switch(i){case 1:n.exlow=n.exhigh=t.fEX[a],n.eylow=n.eyhigh=t.fEY[a];break;case 2:n.exlow=t.fExL[a],n.exhigh=t.fExH[a],n.eylow=t.fEyL[0][a],n.eyhigh=t.fEyH[0][a];break;case 3:n.exlow=t.fEXlow[a],n.exhigh=t.fEXhigh[a],n.eylow=t.fEYlow[a],n.eyhigh=t.fEYhigh[a]}0===a&&(this.xmin=this.xmax=n.x,this.ymin=this.ymax=n.y),i>0?(this.xmin=Math.min(this.xmin,n.x-n.exlow,n.x+n.exhigh),this.xmax=Math.max(this.xmax,n.x-n.exlow,n.x+n.exhigh),this.ymin=Math.min(this.ymin,n.y-n.eylow,n.y+n.eyhigh),this.ymax=Math.max(this.ymax,n.y-n.eylow,n.y+n.eyhigh)):(this.xmin=Math.min(this.xmin,n.x),this.xmax=Math.max(this.xmax,n.x),this.ymin=Math.min(this.ymin,n.y),this.ymax=Math.max(this.ymax,n.y))}}getHistRangeMargin(){return.1}createHistogram(t,i){!t&&!i&&(t=i=!0);const e=this.getGraph(),a=this.xmin,n=this.getHistRangeMargin();let h=this.xmax,c=this.ymin,r=this.ymax;a>=h&&(h=a+1),c>=r&&(r=c+1);const x=(h-a)*n,u=(r-c)*n;let l=a-x,f=h+x,y=c-u,s=r+u;if(c>0&&y<=0&&(y=(1-n)*c),r<0&&s>=0&&(s=(1-n)*r),!this._not_adjust_hrange){const d=this.getPadPainter()?.getPadLog("x");l<0&&a>=0&&(l=d?a*(1-n):0),f>0&&h<=0&&(f=d?(1+n)*h:0)}const o=y,g=s;let m=this.getHistogram();return m?m.fMaximum!==p.kNoZoom&&m.fMinimum!==p.kNoZoom&&(y=m.fMinimum,s=m.fMaximum):(m=this._is_scatter?(0,p.createHistogram)(p.clTH2I,30,30):(0,p.createHistogram)(p.clTH1I,100),m.fName=e.fName+"_h",m.fBits|=p.kNoStats,this._own_histogram=!0,this.setHistogram(m)),e.fMinimum!==p.kNoZoom&&(y=c=e.fMinimum),e.fMaximum!==p.kNoZoom&&(s=e.fMaximum),y<0&&c>=0&&(y=(1-n)*c),r<0&&s>=0&&(s=(1-n)*r),(0,p.setHistogramTitle)(m,this.getObject().fTitle),t&&!m.fXaxis.fLabels&&(m.fXaxis.fXmin=l,m.fXaxis.fXmax=f),i&&!m.fYaxis.fLabels&&(m.fYaxis.fXmin=Math.min(o,y),m.fYaxis.fXmax=Math.max(g,s),this._is_scatter||(m.fMinimum=y,m.fMaximum=s)),m.$ymin_nz=c>0?c:void 0,m}unzoomUserRange(t,i){const e=this.getGraph();if(this._own_histogram||!e)return!1;const a=this.getHistogram();return i=i&&a&&(a.fYaxis.fXmin>this.ymin||a.fYaxis.fXmax<this.ymax),!(!(t=t&&a&&(a.fXaxis.fXmin>this.xmin||a.fXaxis.fXmax<this.xmax))&&!i||(this.createHistogram(t,i),this.getMainPainter()?.extractAxesProperties(1),0))}canOptimize(){return p.settings.OptimizeDraw>0&&!this.options.NoOpt}optimizeBins(t,i){if(this.bins.length<30&&!i)return this.bins;let e=null;if((0,p.isFunc)(i))for(let h=0;h<this.bins.length;++h)i(this.bins[h],h)?e||(e=0===h?[]:this.bins.slice(0,h)):e&&e.push(this.bins[h]);if(e||(e=this.bins),t||(t=5e5),e.length<t||!this.canOptimize())return e;let a=Math.floor(e.length/t);a<2&&(a=2);const n=[];for(let h=0;h<e.length;h+=a)n.push(e[h]);return n}needDrawFunc(t,i){return i._typename===p.clTPaveStats?"stats"!==i.fName||!t.TestBit(p.kNoStats):i._typename!==p.clTF1&&i._typename!==p.clTF2||!i.TestBit((0,p.BIT)(9))}getTooltips(t){const e=[],a=this.get_main().getGrFuncs(this.options.second_x,this.options.second_y),n=this.get_gme();if(e.push(this.getObjectHint()),t&&a)if(void 0!==t.indx&&e.push("p = "+t.indx),e.push("x = "+a.axisAsText("x",t.x),"y = "+a.axisAsText("y",t.y)),n?e.push("error x = -"+a.axisAsText("x",n.fExL[t.indx])+"/+"+a.axisAsText("x",n.fExH[t.indx])):this.options.Errors&&a.x_handle.kind===S.UV&&(t.exlow||t.exhigh)&&e.push("error x = -"+a.axisAsText("x",t.exlow)+"/+"+a.axisAsText("x",t.exhigh)),n)for(let h=0;h<n.fNYErrors;++h)e.push(`error y${h} = -${a.axisAsText("y",n.fEyL[h][t.indx])}/+${a.axisAsText("y",n.fEyH[h][t.indx])}`);else(this.options.Errors||this.options.EF>0)&&a.y_handle.kind===S.UV&&(t.eylow||t.eyhigh)&&e.push("error y = -"+a.axisAsText("y",t.eylow)+"/+"+a.axisAsText("y",t.eyhigh));return e}get_main(){let t=this.getFramePainter();if(t?.grx&&t?.gry)return t;const i=this.getPadPainter(),e=i?.getPadRect()||{width:800,height:600};return t={pad_layer:!0,pad:i?.getRootPad(!0)??(0,p.create)(p.clTPad),pw:e.width,ph:e.height,fX1NDC:.1,fX2NDC:.9,fY1NDC:.1,fY2NDC:.9,getFrameWidth(){return this.pw},getFrameHeight(){return this.ph},grx(a){return(a=this.pad.fLogx?a>0?Math.log10(a):this.pad.fUxmin:(a-this.pad.fX1)/(this.pad.fX2-this.pad.fX1))*this.pw},gry(a){return(1-(a=this.pad.fLogv??this.pad.fLogy?a>0?Math.log10(a):this.pad.fUymin:(a-this.pad.fY1)/(this.pad.fY2-this.pad.fY1)))*this.ph},revertAxis(a,n){return"x"===a?n/this.pw*(this.pad.fX2-this.pad.fX1)+this.pad.fX1:"y"===a?(1-n/this.ph)*(this.pad.fY2-this.pad.fY1)+this.pad.fY1:n},getGrFuncs(){return this}},t.pad?t:null}appendExclusion(t,i,e,a){const n=[];for(let c=e.length-1;c>=0;--c){const r=e[c],x=Math.sqrt(r.dgrx**2+r.dgry**2);x>1e-10&&(r.grx+=a*r.dgry/x,r.gry-=a*r.dgrx/x),n.push(r)}const h=(0,E.Mw)(n,{cmd:"L",line:!t});this.draw_g.append("svg:path").attr("d",i+h+"Z").call(this.fillatt.func).style("opacity",.75)}drawBins(t,i,e,a,n,h,c,r){const x=this.getGraph();if(!x?.fNpoints)return;let u=0,l=null;const f=this.isBatchMode()||!i.Line&&!i.Errors?null:"none";if(r&&h.excl_side&&(u=h.excl_width,h.width>0&&!i.Line&&!i.Curve&&(i.Line=1)),i.EF){l=this.optimizeBins(i.EF>1?2e4:0);for(let d=0;d<l.length;++d){const _=l[d];_.grx=t.grx(_.x),_.gry=t.gry(_.y-_.eylow)}const s=(0,E.Mw)(l,{line:i.EF<2,qubic:!0}),o=[];for(let d=l.length-1;d>=0;--d){const _=l[d];_.gry=t.gry(_.y+_.eyhigh),o.push(_)}const g=(0,E.Mw)(o,{line:i.EF<2,cmd:"L",qubic:!0}),m=e.append("svg:path").attr("d",s+g+"Z").call(c.func);c.empty()&&c.colorindx&&m.style("stroke",this.getColor(c.colorindx)),r&&(this.draw_kind="lines")}if(i.Line||i.Fill){let s="";this._cutg&&(s="Z",i.original||(i.Fill=1)),i.Fill&&(s="Z",u=0),l||(l=this.optimizeBins(0));for(let m=0;m<l.length;++m){const d=l[m];d.grx=t.grx(d.x),d.gry=t.gry(d.y)}const o=(0,E.Mw)(l,{line:!0,calc:u});u&&this.appendExclusion(!1,o,l,u);const g=e.append("svg:path").attr("d",o+s).style("pointer-events",f);i.Line&&g.call(h.func),i.Fill?g.call(c.func):g.style("fill","none"),r&&(this.draw_kind="lines")}if(i.Curve){let s=l;if("lines"!==this.draw_kind||!s||1===i.Curve&&s.length>2e4){s=this.optimizeBins(1===i.Curve?2e4:0);for(let g=0;g<s.length;++g){const m=s[g];m.grx=t.grx(m.x),m.gry=t.gry(m.y)}}const o=(0,E.Mw)(s,{qubic:!u});u&&this.appendExclusion(!0,o,s,u),e.append("svg:path").attr("d",o).call(h.func).style("fill","none").style("pointer-events",f),r&&(this.draw_kind="lines")}let y=null;if((i.Errors||i.Rect||i.Bar)&&(l=this.optimizeBins(5e3,(s,o)=>{const g=t.grx(s.x);if(!i.Bar&&(g<0||g>a))return!0;const m=t.gry(s.y);return!i.Bar&&!i.OutRange&&(m<0||m>n)||(s.grx1=Math.round(g),s.gry1=Math.round(m),this.has_errors&&(s.grx0=Math.round(t.grx(s.x-i.ScaleErrX*s.exlow)-g),s.grx2=Math.round(t.grx(s.x+i.ScaleErrX*s.exhigh)-g),s.gry0=Math.round(t.gry(s.y-s.eylow)-m),s.gry2=Math.round(t.gry(s.y+s.eyhigh)-m),this.is_bent?(s.grdx0=Math.round(t.gry(s.y+x.fEXlowd[o])-m),s.grdx2=Math.round(t.gry(s.y+x.fEXhighd[o])-m),s.grdy0=Math.round(t.grx(s.x+x.fEYlowd[o])-g),s.grdy2=Math.round(t.grx(s.x+x.fEYhighd[o])-g)):s.grdx0=s.grdx2=s.grdy0=s.grdy2=0),!1)}),r&&(this.draw_kind="nodes"),y=e.selectAll(".grpoint").data(l).enter().append("svg:g").attr("class","grpoint").attr("transform",s=>(0,E.bk)(s.grx1,s.gry1))),i.Bar){let s=0,o=0;for(let d=0;d<l.length;++d)0===d?s=o=l[d].grx1:(s=Math.min(s,l[d].grx1),o=Math.max(o,l[d].grx1));if(1===l.length)l[0].width=a/4;else for(let d=0;d<l.length;++d)l[d].width=(o-s)/l.length*p.gStyle.fBarWidth;const g=Math.round(t.gry(0));let m=c;if(r){const d=this.getFramePainter(),_=d?.fillatt?.empty()?-1:d.fillatt.getFillColor();_===c.getFillColor()&&(m=this.createAttFill({color:"white"===_?F.tA:F.$q,pattern:1001,std:!1}))}y.append("svg:path").attr("d",d=>{d.bar=!0;const _=d.width>1?Math.round(-d.width/2):0,b=d.width>1?Math.round(d.width):1;return`M${_},${1!==i.Bar?0:d.gry1>g?g-d.gry1:0}h${b}v${1!==i.Bar?n>d.gry1?n-d.gry1:0:Math.abs(g-d.gry1)}h${-b}z`}).call(m.func)}if(i.Rect&&y.filter(s=>s.exlow>0&&s.exhigh>0&&s.eylow>0&&s.eyhigh>0).append("svg:path").attr("d",s=>(s.rect=!0,`M${s.grx0},${s.gry0}H${s.grx2}V${s.gry2}H${s.grx0}Z`)).call(c.func).call(2===i.Rect?h.func:()=>{}),this.error_size=0,i.Errors){let s=h.width+p.gStyle.fEndErrorSize,o=0;const g=i.Ends?`m0,${s}v${-2*s}`:"",m=i.Ends?`m${s},0h${-2*s}`:"";let d=g,_=g,b=m,w=m;const v=(M,T)=>{if(!i.MainError)return`M${M},${T}`;const G="M0,0";return M?G+(T?`L${M},${T}`:`H${M}`):T?G+`V${T}`:G};switch(i.Ends){case 2:o=Math.max(h.width+1,Math.round(.66*s)),d=`m${o},${s}h${-o}v${-2*s}h${o}`,_=`m${-o},${s}h${o}v${-2*s}h${-o}`,b=`m${-s},${o}v${-o}h${2*s}v${o}`,w=`m${-s},${-o}v${o}h${2*s}v${-o}`;break;case 3:s=Math.max(s,Math.round(8*x.fMarkerSize*.66)),o=Math.max(h.width+1,Math.round(.66*s)),d=`l${o},${s}v${-2*s}l${-o},${s}`,_=`l${-o},${s}v${-2*s}l${o},${s}`,b=`l${-s},${o}h${2*s}l${-s},${-o}`,w=`l${-s},${-o}h${2*s}l${-s},${o}`;break;case 4:s=Math.max(s,Math.round(8*x.fMarkerSize*.66)),o=Math.max(h.width+1,Math.round(.66*s)),d=`l${o},${s}m0,${-2*s}l${-o},${s}`,_=`l${-o},${s}m0,${-2*s}l${o},${s}`,b=`l${-s},${o}m${2*s},0l${-s},${-o}`,w=`l${-s},${-o}m${2*s},0l${-s},${o}`}this.error_size=s,s=Math.floor((h.width-1)/2);let $=y.filter(M=>M.exlow>0||M.exhigh>0||M.eylow>0||M.eyhigh>0);(i.skip_errors_x0||i.skip_errors_y0)&&($=$.filter(M=>!(0===M.x&&i.skip_errors_x0||0===M.y&&i.skip_errors_y0))),!this.isBatchMode()&&p.settings.Tooltip&&r&&$.append("svg:path").attr("d",M=>`M${M.grx0},${M.gry0}h${M.grx2-M.grx0}v${M.gry2-M.gry0}h${M.grx0-M.grx2}z`).style("fill","none").style("pointer-events","visibleFill"),$.append("svg:path").attr("d",M=>(M.error=!0,(M.exlow>0?v(M.grx0+s,M.grdx0)+d:"")+(M.exhigh>0?v(M.grx2-s,M.grdx2)+_:"")+(M.eylow>0?v(M.grdy0,M.gry0-s)+w:"")+(M.eyhigh>0?v(M.grdy2,M.gry2+s)+b:""))).style("fill","none").call(h.func)}if(i.Mark){this.createAttMarker({attr:x,style:i.Mark-100}),this.marker_size=this.markeratt.getFullSize(),this.markeratt.resetPos();const s=!this.isBatchMode()&&p.settings.Tooltip&&(!this.markeratt.fill||this.marker_size<7)&&!y&&r,o=Math.max(5,Math.round(.7*this.marker_size)),g=1e6/(this.markeratt.getMarkerLength()+7);let d,_,b,m="",w="",v=1;l?this.canOptimize()&&l.length>1.5*g&&(v=Math.min(2,Math.round(l.length/g))):l=this.optimizeBins(g);for(let $=0;$<l.length;$+=v)d=l[$],_=t.grx(d.x),_>-this.marker_size&&_<a+this.marker_size&&(b=t.gry(d.y),b>-this.marker_size&&b<n+this.marker_size&&(m+=this.markeratt.create(_,b),s&&(w+=`M${_-o},${b-o}h${2*o}v${2*o}h${-2*o}z`)));m&&(e.append("svg:path").attr("d",m).call(this.markeratt.func),null===y&&"none"===this.draw_kind&&r&&(this.draw_kind=101===i.Mark?"path":"mark")),s&&w&&e.append("svg:path").attr("d",w).style("fill","none").style("pointer-events","visibleFill")}}appendQQ(t,i){const e=Math.max(t.scale_xmin,i.fXq1),a=Math.min(t.scale_xmax,i.fXq2),n=Math.max(t.scale_ymin,i.fYq1),h=Math.min(t.scale_ymax,i.fYq2),c=(y,s,o,g)=>`M${t.grx(y)},${t.gry(s)}L${t.grx(o)},${t.gry(g)}`,r=(i.fYq2-i.fYq1)*(t.scale_xmin-i.fXq1)/(i.fXq2-i.fXq1)+i.fYq1,x=(i.fYq2-i.fYq1)*(t.scale_xmax-i.fXq1)/(i.fXq2-i.fXq1)+i.fYq1;let u="";u=r<t.scale_ymin?c((i.fXq2-i.fXq1)*(t.scale_ymin-i.fYq1)/(i.fYq2-i.fYq1)+i.fXq1,t.scale_ymin,e,n):c(t.scale_xmin,r,e,n),u+=x>t.scale_ymax?c(a,h,(i.fXq2-i.fXq1)*(t.scale_ymax-i.fYq1)/(i.fYq2-i.fYq1)+i.fXq1,t.scale_ymax):c(a,h,t.scale_xmax,x);const l=this.createAttLine({style:1,width:1,color:F.tA,std:!1}),f=this.createAttLine({style:2,width:1,color:F.tA,std:!1});this.draw_g.append("path").attr("d",c(e,n,a,h)).call(l.func).style("fill","none"),this.draw_g.append("path").attr("d",u).call(f.func).style("fill","none")}drawBins3D(){console.log("Load ./hist/TGraphPainter.mjs to draw graph in 3D")}createGraphDrawAttributes(t){const i=this.getGraph(),e=this.options;if(e._pfc>1||e._plc>1||e._pmc>1){const a=this.getPadPainter();if((0,p.isFunc)(a?.getAutoColor)){const n=a.getAutoColor(i.$num_graphs);this._auto_exec="",e._pfc>1&&(e._pfc=1,i.fFillColor=n,this._auto_exec+=`SetFillColor(${n});;`,delete this.fillatt),e._plc>1&&(e._plc=1,i.fLineColor=n,this._auto_exec+=`SetLineColor(${n});;`,delete this.lineatt),e._pmc>1&&(e._pmc=1,i.fMarkerColor=n,this._auto_exec+=`SetMarkerColor(${n});;`,delete this.markeratt)}}t?this.deleteAttr():(this.createAttLine({attr:i,can_excl:!0}),this.createAttFill({attr:i}))}drawGraph(){const t=this.get_main(),i=this.getGraph();if(!t||!this.options)return;if(this.options.pos3d)return this.drawBins3D(t,i);const e=!!this.get_gme(),a=t.getGrFuncs(this.options.second_x,this.options.second_y),n=t.getFrameWidth(),h=t.getFrameHeight();this.createG(!t.pad_layer),this.createGraphDrawAttributes(),this.fillatt.used=!1,this.draw_kind="none",this.marker_size=0;const c=e?this.draw_g.append("svg:g"):this.draw_g;if(this.drawBins(a,this.options,c,n,h,this.lineatt,this.fillatt,!0),"TGraphQQ"===i._typename&&this.appendQQ(a,i),e){for(let r=0;r<i.fNYErrors;++r){let x=this.lineatt,u=this.fillatt;this.options.individual_styles&&(x=this.createAttLine({attr:i.fAttLine[r],std:!1}),u=this.createAttFill({attr:i.fAttFill[r],std:!1}));const l=this.draw_g.append("svg:g"),f=r<this.options.blocks.length?this.options.blocks[r]:this.options;this.extractGmeErrors(r),this.drawBins(a,f,l,n,h,x,u)}this.extractGmeErrors(0)}this.isBatchMode()||((0,H.X2)(this,this.testEditable()),(0,R.wh)(this))}extractTooltip(t){if(!t)return null;if("lines"===this.draw_kind||"path"===this.draw_kind||"mark"===this.draw_kind)return this.extractTooltipForPath(t);if("nodes"!==this.draw_kind)return null;const i=this.get_main(),e=i.getFrameHeight(),a=this.error_size,n=1===this.options.Bar,h=n?i.getGrFuncs(this.options.second_x,this.options.second_y):null,c=this.marker_size?Math.round(this.marker_size/2+1.5):0;let r=null,x=1e10,u=null;if(this.draw_g.selectAll(".grpoint").each(function(){const s=(0,X.Lt)(this).datum();if(void 0===s)return;let g,o=(t.x-s.grx1)**2;if(1===t.nproc&&(o+=(t.y-s.gry1)**2),o>=x)return;if(s.error||s.rect||s.marker)g={x1:Math.min(-a,s.grx0,-c),x2:Math.max(a,s.grx2,c),y1:Math.min(-a,s.gry2,-c),y2:Math.max(a,s.gry0,c)};else if(s.bar){if(g={x1:-s.width/2,x2:s.width/2,y1:0,y2:e-s.gry1},n){const _=h.gry(0);g.y1=s.gry1>_?_-s.gry1:0,g.y2=s.gry1>_?0:_-s.gry1}}else g={x1:-5,x2:5,y1:-5,y2:5};const d=t.y>=s.gry1+g.y1&&t.y<=s.gry1+g.y2;t.x>=s.grx1+g.x1&&t.x<=s.grx1+g.x2&&(d||t.nproc>1)&&(x=o,r=this,u=g,u.exact=d)}),null===r)return null;const l=(0,X.Lt)(r).datum(),f=this.getGraph(),y={name:f.fName,title:f.fTitle,x:l.grx1,y:l.gry1,color1:this.lineatt.color,lines:this.getTooltips(l),rect:u,d3bin:r};return y.user_info={obj:f,name:f.fName,bin:l.indx,cont:l.y,grx:l.grx1,gry:l.gry1},this.fillatt?.used&&!this.fillatt?.empty()&&(y.color2=this.fillatt.getFillColor()),u.exact&&(y.exact=!0),y.menu=y.exact,y.menu_dist=3,y.bin=l,y.binindx=l.indx,y}showTooltip(t){let i=this.draw_g?.selectChild(".tooltip_bin");if(!t||!this.draw_g)return void i?.remove();if(t.usepath)return this.showTooltipForPath(t);const e=(0,X.Lt)(t.d3bin).datum();i.empty()&&(i=this.draw_g.append("svg:rect").attr("class","tooltip_bin").style("pointer-events","none").call(E.Ru)),t.changed=i.property("current_bin")!==t.d3bin,t.changed&&i.attr("x",e.grx1+t.rect.x1).attr("width",t.rect.x2-t.rect.x1).attr("y",e.gry1+t.rect.y1).attr("height",t.rect.y2-t.rect.y1).style("opacity","0.3").property("current_bin",t.d3bin)}processTooltipEvent(t){const i=this.extractTooltip(t);return(!t||!t.disabled)&&this.showTooltip(i),i}findBestBin(t){if(!this.bins)return null;const i="lines"===this.draw_kind,e=this.get_main().getGrFuncs(this.options.second_x,this.options.second_y);let c,r,x,u,l,a=-1,n=null,h=1e10;for(u=0;u<this.bins.length;++u)l=this.bins[u],r=e.grx(l.x),x=e.gry(l.y),c=(t.x-r)**2+(t.y-x)**2,c<h&&(h=c,n=l,a=u);h>100&&i&&(n=null);let f=Math.max(this.lineatt.width+3,4);this.marker_size>0&&(f=Math.max(this.marker_size,f)),n&&(h=Math.sqrt((t.x-e.grx(n.x))**2+(t.y-e.gry(n.y))**2)),!i&&h>f&&(n=null),n||(a=-1);const y={bin:n,indx:a,dist:h,radius:Math.round(f)};if(!n&&i){h=1e10;const s=(_,b,w)=>b>=_&&_>=w||b<=_&&_<=w;let m,o=this.bins[0],g=e.grx(o.x),d=0;for(u=1;u<this.bins.length;++u)l=this.bins[u],r=e.grx(l.x),s(t.x,g,r)&&(m=e.gry(o.y),x=e.gry(l.y),Math.abs(r-g)<1?(d=t.y,c=s(t.y,m,x)?0:Math.min(Math.abs(t.y-m),Math.abs(t.y-x))):(d=m+(t.x-g)/(r-g)*(x-m),c=Math.abs(d-t.y)),c<h&&(h=c,y.linex=t.x,y.liney=d)),o=l,g=r;h<.5*f&&(y.linedist=h,y.closeline=!0)}return y}testEditable(t){const i=this.getGraph();return!!i&&(("toggle"===t||void 0!==t&&!t!==i.TestBit(P))&&i.InvertBit(P),!i.TestBit(P))}extractTooltipForPath(t){if(null===this.bins)return null;const i=this.findBestBin(t);if(!i||!i.bin&&!i.closeline)return null;const e="lines"===this.draw_kind,a="mark"===this.draw_kind,h=this.get_main().getGrFuncs(this.options.second_x,this.options.second_y),c=this.getGraph(),r={name:c.fName,title:c.fTitle,x:i.bin?h.grx(i.bin.x):i.linex,y:i.bin?h.gry(i.bin.y):i.liney,color1:this.lineatt.color,lines:this.getTooltips(i.bin),usepath:!0};return r.user_info={obj:c,name:c.fName,bin:0,cont:0,grx:r.x,gry:r.y},r.ismark=a,r.islines=e,i.closeline?(r.menu=r.exact=!0,r.menu_dist=i.linedist):i.bin&&(this.options.EF&&e?(r.gry1=h.gry(i.bin.y-i.bin.eylow),r.gry2=h.gry(i.bin.y+i.bin.eyhigh)):r.gry1=r.gry2=h.gry(i.bin.y),r.binindx=i.indx,r.bin=i.bin,r.radius=i.radius,r.user_info.bin=i.indx,r.user_info.cont=i.bin.y,r.exact=Math.abs(t.x-r.x)<=i.radius&&(Math.abs(t.y-r.gry1)<=i.radius||Math.abs(t.y-r.gry2)<=i.radius),r.menu=r.exact,r.menu_dist=Math.sqrt((t.x-r.x)**2+Math.min(Math.abs(t.y-r.gry1),Math.abs(t.y-r.gry2))**2)),this.fillatt?.used&&!this.fillatt?.empty()&&(r.color2=this.fillatt.getFillColor()),e||(r.color1=this.getColor(c.fMarkerColor),r.color2||(r.color2=r.color1)),r}showTooltipForPath(t){let i=this.draw_g?.selectChild(".tooltip_bin");if(t?.bin&&this.draw_g){if(i.empty()&&(i=this.draw_g.append("svg:g").attr("class","tooltip_bin")),t.changed=i.property("current_bin")!==t.bin,t.changed)if(i.selectAll("*").remove(),i.property("current_bin",t.bin),t.ismark)i.append("svg:rect").style("pointer-events","none").call(E.Ru).style("opacity","0.3").attr("x",Math.round(t.x-t.radius)).attr("y",Math.round(t.y-t.radius)).attr("width",2*t.radius).attr("height",2*t.radius);else{i.append("svg:circle").attr("cy",Math.round(t.gry1)),Math.abs(t.gry1-t.gry2)>1&&i.append("svg:circle").attr("cy",Math.round(t.gry2));const e=i.selectAll("circle").attr("r",t.radius).attr("cx",Math.round(t.x));t.islines?(this.options.Line||this.options.Curve?e.call(this.lineatt.func):e.style("stroke","black"),this.options.Fill?e.call(this.fillatt.func):e.style("fill","none")):e.style("stroke","black"===t.color1?"green":"black").style("fill","none")}}else i?.remove()}moveEnabled(){return this.testEditable()}moveStart(t,i){this.pos_dx=this.pos_dy=0,this.move_funcs=this.get_main().getGrFuncs(this.options.second_x,this.options.second_y);const e=this.extractTooltip({x:t,y:i});e&&e.exact&&void 0!==e.binindx?(this.move_binindx=e.binindx,this.move_bin=e.bin,this.move_x0=this.move_funcs.grx(this.move_bin.x),this.move_y0=this.move_funcs.gry(this.move_bin.y)):delete this.move_binindx}moveDrag(t,i){this.pos_dx+=t,this.pos_dy+=i,void 0===this.move_binindx?(0,E.bk)(this.draw_g,this.pos_dx,this.pos_dy):this.move_funcs&&this.move_bin&&(this.move_bin.x=this.move_funcs.revertAxis("x",this.move_x0+this.pos_dx),this.move_bin.y=this.move_funcs.revertAxis("y",this.move_y0+this.pos_dy),this.drawGraph())}moveEnd(t){const i=this.getGraph(),e=i?.fNpoints-1;let a="";const n=h=>{a+=`SetPoint(${h.indx},${h.x},${h.y});;`,i.fX[h.indx]=h.x,i.fY[h.indx]=h.y,0===h.indx&&this._cutg_lastsame&&(a+=`SetPoint(${e},${h.x},${h.y});;`,i.fX[e]=h.x,i.fY[e]=h.y)};if(void 0===this.move_binindx){if(this.draw_g.attr("transform",null),this.move_funcs&&this.bins&&!t){for(let h=0;h<this.bins.length;++h){const c=this.bins[h];c.x=this.move_funcs.revertAxis("x",this.move_funcs.grx(c.x)+this.pos_dx),c.y=this.move_funcs.revertAxis("y",this.move_funcs.gry(c.y)+this.pos_dy),n(c)}i.$redraw_pad?this.redrawPad():this.drawGraph()}}else n(this.move_bin),delete this.move_binindx,i.$redraw_pad&&this.redrawPad();delete this.move_funcs,a&&!t&&this.submitCanvExec(a)}fillWebObjectOptions(t){this._auto_exec&&t&&(t.fcust="auto_exec:"+this._auto_exec,delete this._auto_exec)}fillContextMenuItems(t){this.snapid||(t.addchk(this.testEditable(),"Editable",()=>{this.testEditable("toggle"),this.drawGraph()}),t.addRedrawMenu(this.getPrimary()))}executeMenuCommand(t,i){if(super.executeMenuCommand(t,i))return!0;const e=this.getCanvPainter(),a=this.get_main();if("RemovePoint"===t.fName||"InsertPoint"===t.fName){if(!e||e._readonly)return!0;const n=(0,p.isFunc)(a?.getLastEventPos)?a.getLastEventPos():null,h=this.extractTooltip(n);if("InsertPoint"===t.fName){if(n){const c=a.getGrFuncs(this.options.second_x,this.options.second_y),r=c.revertAxis("x",n.x)??0,x=c.revertAxis("y",n.y)??0;this.submitCanvExec(`AddPoint(${r.toFixed(3)}, ${x.toFixed(3)})`,t.$execid)}}else t.$execid&&void 0!==h?.binindx&&this.submitCanvExec(`RemovePoint(${h.binindx})`,t.$execid);return!0}return!1}_updateMembers(t,i){t.fBits=i.fBits,t.fTitle=i.fTitle,t.fX=i.fX,t.fY=i.fY,t.fNpoints=i.fNpoints,t.fMinimum=i.fMinimum,t.fMaximum=i.fMaximum;const e=this.options;return void 0!==this.snapid&&(e._pfc=e._plc=e._pmc=0),e._pfc||(t.fFillColor=i.fFillColor),t.fFillStyle=i.fFillStyle,e._plc||(t.fLineColor=i.fLineColor),t.fLineStyle=i.fLineStyle,t.fLineWidth=i.fLineWidth,e._pmc||(t.fMarkerColor=i.fMarkerColor),t.fMarkerSize=i.fMarkerSize,t.fMarkerStyle=i.fMarkerStyle,i.fFunctions}updateObject(t,i){if(!this.matchObjectType(t))return!1;i&&i!==this.options.original&&this.decodeOptions(i);const e=this._updateMembers(this.getObject(),t);if(this.createBins(),delete this.$redraw_hist,this.axes_draw){const a=this.createHistogram(),n=this.getMainPainter();n?.isSecondary(this)&&(n.updateObject(a,this.options.Axis),this.$redraw_hist=!0)}return this._funcHandler=new N.eP(this,this.getPadPainter(),e),!0}canZoomInside(t,i,e){const a=this.getGraph();if(!a||"x"!==t&&"y"!==t)return!1;let n=a.fX;if(this._is_scatter)n="x"===t?a.fX:a.fY;else if(t!==(this.options.pos3d?"y":"x"))return!1;for(let h=0;h<a.fNpoints;++h)if(i<n[h]&&n[h]<e)return!0;return!1}clickButton(t){return"ToggleZoom"===t&&(this.xmin!==this.xmax||this.ymin!==this.ymax)&&this.getFramePainter()?.zoom(this.xmin,this.xmax,this.ymin,this.ymax)}findFunc(){return this.getGraph()?.fFunctions?.arr?.find(t=>t._typename===p.clTF1||t._typename===p.clTF2)}findStat(){return this.getGraph()?.fFunctions?.arr?.find(t=>t._typename===p.clTPaveStats&&"stats"===t.fName)}createStat(){const t=this.findFunc();if(!t)return null;let i=this.findStat();if(i)return i;if(this.getCanvPainter()?.normal_canvas)return null;this.create_stats=!0;const e=p.gStyle;return i=(0,p.create)(p.clTPaveStats),Object.assign(i,{fName:"stats",fOptStat:0,fOptFit:e.fOptFit||111,fBorderSize:1,fX1NDC:e.fStatX-e.fStatW,fY1NDC:e.fStatY-e.fStatH,fX2NDC:e.fStatX,fY2NDC:e.fStatY,fFillColor:e.fStatColor,fFillStyle:e.fStatStyle}),i.fTextAngle=0,i.fTextSize=e.fStatFontSize,i.fTextAlign=12,i.fTextColor=e.fStatTextColor,i.fTextFont=e.fStatFont,i.AddText(t.fName),this.getGraph().fFunctions.Add(i),i}fillStatistic(t,i,e){const a=this.findFunc();return!(!a||!e||(t.clearPave(),t.fillFunctionStat(a,1===e?111:e,1),0))}drawAxisHisto(){var t=this;return(0,A.A)(function*(){const i=t.createHistogram();return z.N.draw(t.getDrawDom(),i,t.options.Axis)})()}static _drawGraph(t,i){return(0,A.A)(function*(){t.decodeOptions(i,!0),t.createBins(),t.createStat();const e=t.getGraph();!p.settings.DragGraphs&&e&&!e.TestBit(P)&&e.InvertBit(P);let a=Promise.resolve();return(!t.getMainPainter()||t.options.second_x||t.options.second_y)&&t.options.Axis&&(a=t.drawAxisHisto().then(n=>{n?.setSecondaryId(t,"hist"),t.axes_draw=!!n})),a.then(()=>(t.addToPadPrimitives(),t.drawGraph())).then(()=>new N.eP(t,t.getPadPainter(),e.fFunctions,!0).drawNext(0))})()}static draw(t,i,e){return(0,A.A)(function*(){return C._drawGraph(new C(t,i),e)})()}}}}]);